<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFA MVP Test Interface</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .qr-code {
            max-width: 300px;
            margin: 20px auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
                üîê MFA MVP Test Interface
            </h1>

            <!-- Registration Section -->
            <div x-data="mfaApp()" class="space-y-8">

                <!-- API Key Section -->
                <div class="border-2 border-gray-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">API Key</h2>
                    <p class="text-sm text-gray-600 mb-3">Paste your API key (Bearer) to authenticate requests to the MFA API.</p>
                    <input 
                        type="text" 
                        x-model="apiKey" 
                        placeholder="e.g., sk_test_..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500 font-mono"
                    />
                    <p class="text-xs text-gray-500 mt-2">Use /api/v1/bootstrap/seed with an admin token to generate a test key.</p>
                </div>
                
                <!-- Step 1: Register User -->
                <div class="border-2 border-blue-200 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-blue-800 mb-4">
                        Step 1: Register User for MFA
                    </h2>
                    
                    <div class="flex gap-4 items-end">
                        <div class="flex-1 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    User ID
                                </label>
                                <input 
                                    type="text" 
                                    x-model="userId" 
                                    placeholder="Enter user ID (e.g., 33, user123)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Issuer (required)
                                </label>
                                <input 
                                    type="text" 
                                    x-model="issuer" 
                                    placeholder="e.g., Acme Corp"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <p class="text-xs text-gray-500 mt-1">This appears as the provider name in the authenticator app.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Account Name (optional)
                                </label>
                                <input 
                                    type="text" 
                                    x-model="accountName" 
                                    placeholder="e.g., John‚Äôs Work Phone or '-' to hide ID"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <p class="text-xs text-gray-500 mt-1">Shown in the authenticator app. Use '-' to hide the ID.</p>
                            </div>
                        </div>
                        <button 
                            @click="registerUser()" 
                            :disabled="!userId || !issuer || !apiKey || loading"
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span x-show="!loading">Register</span>
                            <span x-show="loading">Loading...</span>
                        </button>
                    </div>

                    <!-- Registration Response -->
                    <div x-show="registrationResponse" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                        <h3 class="font-semibold text-green-800 mb-2">Registration Successful! ‚úÖ</h3>
                        <div class="space-y-2 text-sm">
                            <div><strong>QR URL:</strong> <span x-text="registrationResponse?.qr_code_url" class="font-mono text-xs"></span></div>
                            <div><strong>Secret (for testing):</strong> <span x-text="registrationResponse?.secret" class="font-mono text-xs bg-gray-100 p-1 rounded"></span></div>
                        </div>
                        
                        <!-- Show backup codes -->
                        <div x-show="registrationResponse?.backup_codes" class="mt-4">
                            <strong class="text-green-800">Backup Codes (save these!):</strong>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <template x-for="code in registrationResponse?.backup_codes">
                                    <span x-text="code" class="font-mono text-xs bg-gray-100 p-2 rounded text-center"></span>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div x-show="error" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                        <h3 class="font-semibold text-red-800">Error ‚ùå</h3>
                        <p x-text="error" class="text-red-700 text-sm mt-1"></p>
                    </div>
                </div>

                <!-- Step 2: Get QR Code -->
                <div class="border-2 border-green-200 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-green-800 mb-4">
                        Step 2: Get QR Code
                    </h2>
                    
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                User ID (same as above)
                            </label>
                            <input 
                                type="text" 
                                x-model="qrUserId" 
                                placeholder="Enter user ID to get QR code"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                        </div>
                        <button 
                            @click="getQRCode()" 
                            :disabled="!qrUserId || !apiKey || loading"
                            class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Get QR
                        </button>
                    </div>

                    <!-- QR Code Image -->
                    <div x-show="qrImageUrl" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                        <h3 class="font-semibold text-green-800 mb-2">QR Code ‚úÖ</h3>
                        <div class="mt-2 text-center">
                            <img :src="qrImageUrl" alt="MFA QR Code" class="qr-code inline-block" />
                            <div class="text-xs text-gray-500 mt-2">Scan this QR with your authenticator app</div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Validate OTP -->
                <div class="border-2 border-purple-200 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-purple-800 mb-4">
                        Step 3: Validate OTP Code
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                User ID
                            </label>
                            <input 
                                type="text" 
                                x-model="validateUserId" 
                                placeholder="Enter user ID"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                OTP Code (6 digits)
                            </label>
                            <input 
                                type="text" 
                                x-model="otpCode" 
                                placeholder="123456"
                                maxlength="6"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-center text-lg"
                            />
                        </div>
                    </div>
                    
                    <button 
                        @click="validateOTP()" 
                        :disabled="!validateUserId || !otpCode || !apiKey || loading"
                        class="mt-4 w-full px-6 py-3 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
                    >
                        <span x-show="!loading">Validate OTP</span>
                        <span x-show="loading">Validating...</span>
                    </button>

                    <!-- Validation Response -->
                    <div x-show="validationResponse" class="mt-4 p-4 rounded-md" 
                         :class="validationResponse?.valid ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                        <h3 class="font-semibold" 
                            :class="validationResponse?.valid ? 'text-green-800' : 'text-red-800'">
                            <span x-show="validationResponse?.valid">‚úÖ Valid OTP!</span>
                            <span x-show="!validationResponse?.valid">‚ùå Invalid OTP</span>
                        </h3>
                        <p x-text="validationResponse?.message" 
                           :class="validationResponse?.valid ? 'text-green-700' : 'text-red-700'"
                           class="text-sm mt-1"></p>
                    </div>
                </div>

                <!-- API Response Log -->
                <div x-show="apiLog.length > 0" class="border-2 border-gray-200 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        API Response Log
                    </h2>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <template x-for="(log, index) in apiLog.slice().reverse()" :key="index">
                            <div class="text-xs font-mono bg-gray-100 p-2 rounded">
                                <div class="font-semibold" x-text="log.timestamp + ' - ' + log.method + ' ' + log.url"></div>
                                <div class="text-gray-600 mt-1" x-text="JSON.stringify(log.response, null, 2)"></div>
                            </div>
                        </template>
                    </div>
                    <button @click="apiLog = []" class="mt-2 text-xs text-gray-500 hover:text-gray-700">
                        Clear Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function mfaApp() {
            return {
                apiKey: '',
                userId: '',
                issuer: '',
                accountName: '',
                qrUserId: '',
                validateUserId: '',
                otpCode: '',
                loading: false,
                error: null,
                registrationResponse: null,
                qrResponse: null, // legacy, no longer used
                qrImageUrl: '',
                validationResponse: null,
                apiLog: [],

                async registerUser() {
                    if (!this.userId) return;
                    
                    this.loading = true;
                    this.error = null;
                    this.registrationResponse = null;

                    try {
                        const response = await fetch('http://localhost:8080/api/v1/mfa/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.apiKey}`,
                            },
                            body: JSON.stringify({ id: this.userId, account_name: this.accountName, issuer: this.issuer })
                        });

                        const data = await response.json();
                        
                        this.logApiCall('POST', '/api/v1/mfa/register', data);
                        
                        if (response.ok) {
                            this.registrationResponse = data;
                            // Auto-fill QR user ID
                            this.qrUserId = this.userId;
                            this.validateUserId = this.userId;
                        } else {
                            this.error = data.error || 'Registration failed';
                        }
                    } catch (err) {
                        this.error = 'Network error: ' + err.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async getQRCode() {
                    if (!this.qrUserId) return;

                    this.loading = true;
                    this.error = null;
                    this.qrResponse = null;
                    this.qrImageUrl = '';

                    const url = `http://localhost:8080/api/v1/mfa/${this.qrUserId}/qr?ts=${Date.now()}`; // cache-bust
                    try {
                        const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${this.apiKey}` } });
                        if (!resp.ok) {
                            const msg = `Failed to get QR (${resp.status})`;
                            this.error = msg;
                            return;
                        }
                        const blob = await resp.blob();
                        this.qrImageUrl = URL.createObjectURL(blob);
                        this.logApiCall('GET', `/api/v1/mfa/${this.qrUserId}/qr`, { content_type: resp.headers.get('Content-Type') || 'image/png' });
                    } catch (err) {
                        this.error = err.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async validateOTP() {
                    if (!this.validateUserId || !this.otpCode) return;
                    
                    this.loading = true;
                    this.error = null;
                    this.validationResponse = null;

                    try {
                        const response = await fetch(`http://localhost:8080/api/v1/mfa/${this.validateUserId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.apiKey}`,
                            },
                            body: JSON.stringify({ otp: this.otpCode })
                        });

                        const data = await response.json();
                        
                        this.logApiCall('POST', `/api/v1/mfa/${this.validateUserId}`, data);
                        
                        this.validationResponse = data;
                        
                        if (!response.ok && !data.valid) {
                            // This is expected for invalid OTP, don't show as error
                        }
                    } catch (err) {
                        this.error = 'Network error: ' + err.message;
                    } finally {
                        this.loading = false;
                    }
                },

                logApiCall(method, url, response) {
                    this.apiLog.push({
                        timestamp: new Date().toLocaleTimeString(),
                        method,
                        url,
                        response
                    });
                }
            }
        }
    </script>
</body>
</html>